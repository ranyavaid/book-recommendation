<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customize Your Book Gift</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Added Inter, Caveat, Roboto, Indie Flower, and Shadows Into Light fonts for note customization -->
    <link
        href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Inter:wght@400;700&family=Roboto:wght@400;700&family=Indie+Flower&family=Shadows+Into+Light&display=swap"
        rel="stylesheet">
    <!-- Font Awesome for icons (search, clear) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Material Icons for the share button -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Lighter cream white background for the first page */
            background: #fdfdfd;
            min-height: 100vh;
            color: #5d4e37;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            /* Stacks children vertically */
            align-items: center;
            /* Centers children horizontally */
            justify-content: center;
        }

        /* Ensure the main landing page content is stacked and centered */
        #mainLandingPage {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            /* Ensure it takes full width within its parent container */
        }

        /* Main heading style for the first page */
        .main-heading {
            font-family: 'Inter', sans-serif;
            font-size: 48px;
            /* Set to 48px */
            font-weight: 700;
            /* Bold */
            color: #5d4e37;
            margin-bottom: 10px;
            text-shadow: none;
            /* Explicitly removed text-shadow */
            text-align: center;
            /* Ensure heading text is centered */
            width: 100%;
            /* Ensure it spans full width for centering */
        }

        /* Tagline style for the first page */
        .tagline {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Regular font */
            font-size: 18px;
            color: #7a6a53;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.5;
            text-align: center;
            /* Ensure tagline text is centered */
            width: 100%;
            /* Ensure it spans full width for centering */
        }

        /* Search Bar Section */
        .search-bar-section {
            margin-top: 30px;
            /* Space from tagline */
            margin-bottom: 40px;
            width: 100%;
            max-width: 600px;
            /* Limits width, but still centered by parent */
            /* text-align: center; Removed as parent flex handles centering */
        }

        .search-input-wrapper {
            display: flex;
            align-items: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 0 10px;
            /* Padding for icons inside */
            background-color: white;
            transition: border-color 0.3s ease;
            width: 100%;
            /* Ensure it takes full width of its parent (.search-bar-section) */
        }

        .search-input-wrapper:focus-within {
            border-color: #A0522D;
        }

        .search-icon,
        .clear-search-btn {
            color: #999;
            font-size: 1.1rem;
            padding: 8px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .search-icon {
            margin-right: 8px;
        }

        .clear-search-btn {
            margin-left: 8px;
            background: none;
            border: none;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
        }

        .clear-search-btn:hover {
            color: #5d4e37;
        }

        .search-input {
            flex-grow: 1;
            /* Takes up available space */
            padding: 12px 0;
            /* Adjust padding as icons have inner padding */
            border: none;
            /* Remove individual border */
            border-radius: 0;
            font-size: 1rem;
            outline: none;
            background: none;
        }

        /* Book Selection Section (for top books / search results) */
        .book-selection-section {
            margin-bottom: 40px;
            width: 100%;
            max-width: 900px;
            /* Wider for the grid */
            text-align: center;
            /* Center the title within this section */
            /* No background, padding, border-radius, box-shadow to make it "float" */
        }

        .section-title {
            font-size: 1.5rem;
            /* Smaller font size */
            margin-top: 30px;
            margin-bottom: 20px;
            color: #8B7355;
            font-weight: 600;
        }

        /* Book Grid for top-rated books and search results */
        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            justify-items: center;
            padding: 10px;
        }

        /* Individual book item (base style for both list and grid) */
        .search-result-item {
            display: flex;
            flex-direction: column;
            /* Default to vertical for grid */
            align-items: center;
            text-align: center;
            padding: 0;
            border: none;
            box-shadow: none;
            background-color: transparent;
            width: auto;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .search-result-item:hover {
            transform: translateY(-3px);
        }

        .search-result-item img {
            width: 120px;
            height: 180px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            /* Subtle shadow for images */
        }

        .search-result-info {
            flex-grow: 1;
            text-align: center;
            /* Center text within the grid item */
        }

        .search-result-info h4 {
            font-weight: 600;
            color: #5d4e37;
            margin-bottom: 4px;
            font-size: 1.2rem;
        }

        .search-result-info p {
            font-size: 0.95rem;
            color: #7a6a53;
        }

        .loading-indicator {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #8B7355;
        }

        /* Book Display Area (Customization Page) */
        .book-display-area {
            display: none;
            /* Hidden by default, shown when a book is selected */
            width: 100%;
            max-width: 800px;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Added background for the second page */
            background: #fdfdfd;
            padding-top: 20px;
            /* Add some padding at the top of this section */
            margin: 0 auto;
            /* Center the book display area itself */
        }

        .book-display-area.visible {
            display: flex;
        }

        /* Back to Search Navigation on customization page */
        .back-to-selection-nav {
            width: 100%;
            max-width: 800px;
            /* Match book display area width */
            margin-bottom: 20px;
            /* Increased space below nav */
            text-align: left;
        }

        /* Style for the new back button */
        .back-nav-button {
            display: inline-flex;
            align-items: center;
            color: #8B7355;
            font-size: 1rem;
            font-weight: 500;
            transition: color 0.2s ease;
            background: none;
            /* Ensure no default button background */
            border: none;
            /* Ensure no default button border */
            cursor: pointer;
            /* Ensure pointer cursor */
            padding: 0;
            /* Remove default button padding */
            outline: none;
            /* Remove outline on focus */
        }

        .back-nav-button:hover {
            color: #A0522D;
        }

        .back-nav-button i {
            margin-right: 8px;
        }

        /* Customization Page Heading */
        .customization-heading {
            font-family: 'Inter', sans-serif;
            font-size: 2.2rem;
            /* Adjusted size for this page */
            font-weight: 700;
            color: #5d4e37;
            margin-bottom: 10px;
            /* Space between heading and subheading */
            text-align: center;
        }

        /* New Subheading for Customization Page */
        .customization-subheading {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.1rem;
            color: #7a6a53;
            margin-bottom: 38px;
            /* Adjusted to create approx 48px total space with heading */
            text-align: center;
            max-width: 500px;
            line-height: 1.4;
        }


        /* 3D Book Container */
        .book-container {
            position: relative;
            width: 330px;
            /* Adjusted to accommodate spine + main book width (300px + 30px) */
            height: 450px;
            /* Standard book height */
            perspective: 1500px;
            /* Controls 3D depth */
            margin-bottom: 30px;
            /* Space below the book before the new menu */
        }

        .book-model {
            position: absolute;
            width: 100%;
            /* Now 330px */
            height: 100%;
            transform-style: preserve-3d;
            /* This container does NOT rotate as a whole */
            transition: transform 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            /* Added transition for smooth centering */
        }

        .book-model.open {
            /* Adjusted transform to visually center the entire opened book (two pages + spine) */
            transform: translateX(135px);
        }

        /* The Stack of Pages (Rest of the book) */
        .book-pages-stack {
            position: absolute;
            left: 30px;
            /* Adjusted to start after the spine */
            top: 0;
            width: calc(100% - 30px);
            /* Now 300px (330 - 30) */
            height: 100%;
            background: linear-gradient(to right, #f0f0f0 0%, #ffffff 50%, #f0f0f0 100%);
            border-radius: 0 8px 8px 0;
            box-shadow: inset 5px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 4;
            /* Below the first page and cover */
        }

        .book-pages-stack::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 15px;
            /* Representation of page edges */
            background: repeating-linear-gradient(to bottom, #dcdcdc, #dcdcdc 2px, #f5f5f5 2px, #f5f5f5 4px);
            opacity: 0.8;
            border-radius: 0 8px 8px 0;
        }

        /* Wrapper for the flipping cover */
        .book-cover-wrapper {
            position: absolute;
            left: 30px;
            /* Adjusted to start after the spine */
            width: calc(100% - 30px);
            /* Now 300px (330 - 30) */
            height: 100%;
            transform-style: preserve-3d;
            transform-origin: 0% 50%;
            /* Pivot from the left edge (spine) */
            transition: transform 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            /* Smooth, realistic flip */
            z-index: 10;
            /* Ensure cover is on top */
        }

        .book-cover-wrapper.open {
            transform: rotateY(-180deg);
            /* Flip open */
        }

        /* Front Cover (Front face of the wrapper) */
        .book-cover-front {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            box-shadow:
                0 20px 40px rgba(0, 0, 0, 0.15),
                0 10px 20px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            background: #fff;
            cursor: pointer;
        }

        .book-cover-front img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Ensures image covers the area */
        }

        .book-cover-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            text-align: center;
            padding: 16px;
        }

        /* Inside of the Front Cover (Back face of the wrapper) */
        .book-cover-inside {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            /* Keep hidden when flipped */
            border-radius: 8px;
            background-color: #E2DFD3;
            /* Default background */
            background-size: 50%;
            /* Smaller image */
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.2;
            /* Less opaque */
            transform: rotateY(180deg);
            /* Flipped to be the inside face */
            overflow: hidden;
            box-shadow: none;
            /* No shadow for plain look */
            transition: opacity 0.5s ease;
            /* Smooth transition for opacity */
        }

        /* First Page (where the note is scribbled) */
        .book-first-page {
            position: absolute;
            left: 30px;
            /* Adjusted to start after the spine */
            top: 0;
            width: calc(100% - 30px);
            /* Now 300px (330 - 30) */
            height: 100%;
            background: #E2DFD3;
            /* Dirty yellow, lighter */
            padding: 40px;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
            z-index: 6;
            /* Between spine/page stack and the cover */
            display: flex;
            flex-direction: column;
            /* Use flexbox for vertical layout */
            /* Removed justify-content: space-between; as menu is now external */
            opacity: 0;
            /* Hidden initially */
            pointer-events: none;
            /* Disable interactions when hidden */
            transition: opacity 0.5s ease 0.8s;
            /* Fade in after cover flips */
        }

        .book-cover-wrapper.open+.book-first-page {
            opacity: 1;
            pointer-events: auto;
            /* Enable interactions when visible */
        }

        /* Close button for the first page (REMOVED) */
        /* .close-btn { ... } */

        /* Note Section */
        .note-section {
            margin-bottom: 0;
            /* No bottom margin needed, note input will take space */
            flex-grow: 1;
            /* Allow note section to take available space */
            display: flex;
            flex-direction: column;
        }

        .note-input {
            width: 100%;
            height: 100%;
            /* Take full height of parent note-section */
            border: none;
            /* Removed border */
            border-radius: 10px;
            padding: 0px;
            /* Keep padding around the content */
            font-family: 'Caveat', cursive;
            /* Default font for note */
            font-size: 20px;
            /* Increased font size to 20px */
            line-height: 1.6;
            /* Keep line height relative */
            color: #5d4e37;
            resize: none;
            background: transparent;
            outline: none;
            transition: border-color 0.3s ease;
            /* Lined paper effect adjustments */
            /* Calculate line height in px: 20px * 1.6 = 32px */
            background-image: linear-gradient(to bottom, transparent 32px, #e0e0e0 32px);
            /* Line at exact line-height */
            background-size: 100% 32px;
            /* Line height */
            padding-top: 15px;
            /* Adjusted padding-top to align text better */
        }

        .note-input:focus {
            border-color: #8B7355;
        }

        .note-input::placeholder {
            color: #8d7b6b;
            /* Removed font-family here to allow inheritance from .note-input */
            font-size: 20px;
            /* Placeholder font size to 20px */
        }

        .note-display {
            /* Changed from display: none; to be controlled by JS logic */
            display: none;
            font-family: 'Caveat', cursive;
            /* Default font for note display */
            font-size: 20px;
            /* Increased font size to 20px */
            line-height: 1.6;
            color: #5d4e37;
            padding: 0px;
            /* Decreased padding */
            background: transparent;
            /* Changed to transparent */
            border-radius: 10px;
            margin-bottom: 15px;
            word-wrap: break-word;
            flex-grow: 1;
            /* Also allow note display to grow */
        }

        .note-display.visible {
            display: block;
        }

        /* Save Button (REMOVED) */
        /* .note-btn { ... } */

        /* Floating Menu at the bottom */
        .floating-menu {
            display: flex;
            flex-direction: column-reverse;
            /* Stack main buttons at the bottom, sub-menus above */
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            /* Space from the book */
            padding: 15px 25px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            width: fit-content;
            /* Shrink to content */
            position: relative;
            /* For absolute positioning of sub-menus */
        }

        .main-menu-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        .main-menu-btn {
            background: white;
            /* White background */
            color: #5d4e37;
            /* Dark text color */
            border: 1px solid #ddd;
            /* Subtle border */
            padding: 12px 20px;
            /* Adjusted padding for square look */
            border-radius: 8px;
            /* Square corners */
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
            /* Ensure consistent button size */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            /* Subtle shadow */
        }

        .main-menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            border-color: #A0522D;
            /* Highlight border on hover */
        }

        /* Specific style for the main Share button to keep it rounded */
        #shareMenuBtn {
            background: linear-gradient(135deg, #A0522D 0%, #8B7355 100%);
            /* Original gradient */
            color: white;
            border-radius: 25px;
            /* Pill shape */
            border: none;
            /* No border for this one */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            /* Stronger shadow */
        }

        #shareMenuBtn:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            /* Stronger hover shadow */
            border-color: transparent;
            /* No border color change */
        }

        /* Sub-menus (hidden by default, appear above) */
        .sub-menu {
            display: none;
            /* Hidden by default */
            flex-direction: row;
            /* Layout content horizontally */
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 10px;
            /* Padding inside the sub-menu box */
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: absolute;
            /* Position relative to .floating-menu */
            bottom: calc(100% + 15px);
            /* Position above the main menu buttons + gap */
            left: 50%;
            transform: translateX(-50%);
            width: max-content;
            /* Adjust width to content */
            min-width: 200px;
            /* Ensure a minimum width */
            z-index: 20;
            /* Ensure it's above other content */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, bottom 0.3s ease;
            /* Smooth transition */
        }

        .sub-menu.visible {
            display: flex;
            /* Show when visible */
            opacity: 1;
            pointer-events: auto;
            bottom: calc(100% + 25px);
            /* Slightly higher when visible for animation */
        }

        .font-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #5d4e37;
        }

        .font-btn:hover {
            background: #f0f0f0;
            border-color: #8B7355;
        }

        .font-btn.active {
            background: #8B7355;
            color: white;
            border-color: #8B7355;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Specific font styles for buttons */
        .font-btn[data-font="Caveat"] {
            font-family: 'Caveat', cursive;
            font-size: 1.1em;
        }

        .font-btn[data-font="Inter"] {
            font-family: 'Inter', sans-serif;
            font-size: 1.1em;
        }

        /* Added Inter */
        .font-btn[data-font="Roboto"] {
            font-family: 'Roboto', sans-serif;
            font-size: 1.1em;
        }

        /* Added Roboto */
        .font-btn[data-font="Indie Flower"] {
            font-family: 'Indie Flower', cursive;
            font-size: 1.1em;
        }

        /* New handwritten font */
        .font-btn[data-font="Shadows Into Light"] {
            font-family: 'Shadows Into Light', cursive;
            font-size: 1.1em;
        }

        /* New handwritten font */


        /* Sticker Section (now a sub-menu) */
        .sticker-tools {
            display: flex;
            /* Overrides default display:none for .sub-menu */
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            /* No margin-bottom as it's part of the sub-menu */
        }

        .sticker-btn {
            background: white;
            border: 2px solid #ddd;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .sticker-btn:hover {
            border-color: #8B7355;
            transform: scale(1.1);
        }

        /* Sticker Bounding Box and Controls */
        .sticker {
            position: absolute;
            cursor: grab;
            /* Change cursor for dragging */
            user-select: none;
            z-index: 10;
            padding: 10px;
            /* Add padding to make the clickable area larger than just the emoji */
            border: 2px dashed transparent;
            /* Default transparent border */
            border-radius: 8px;
            /* Rounded corners for the bounding box */
            box-sizing: content-box;
            /* Ensure padding adds to size, not reduces content area */
            /* Enforce square aspect ratio */
            aspect-ratio: 1 / 1;
            display: flex;
            /* Use flexbox to center the emoji */
            align-items: center;
            /* Center vertically */
            justify-content: center;
            /* Center horizontally */
        }

        .sticker:hover,
        .sticker.dragging {
            border-color: #A0522D;
            /* Show border on hover/drag */
            z-index: 20;
            /* Bring to front when hovered/dragged */
        }

        .sticker.dragging {
            cursor: grabbing;
            /* Cursor feedback during drag */
        }

        .sticker-emoji {
            font-size: 30px;
            /* Default size */
            display: block;
            line-height: 1;
            /* Ensure line height doesn't add extra space */
            transition: font-size 0.1s ease-out;
            /* Smooth font size change */
            /* Removed padding from here, it's now on the parent .sticker */
        }

        .sticker-remove {
            position: absolute;
            top: -12px;
            /* Adjust based on padding/size of button */
            left: -12px;
            /* Position top-left */
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            /* Slightly larger for easier click */
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            /* Larger icon */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 25;
            /* Ensure controls are above sticker */
        }

        .sticker-resize {
            position: absolute;
            bottom: -12px;
            /* Position bottom-right */
            right: -12px;
            /* Adjust based on padding/size of button */
            background: #8B7355;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            /* Slightly larger for easier click */
            height: 24px;
            cursor: nwse-resize;
            /* Diagonal resize cursor */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            /* Larger icon */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 25;
            /* Ensure controls are above sticker */
        }

        /* Removed .resize-slider and its styles */

        /* Share Options (now a sub-menu) */
        .share-options {
            display: flex;
            /* Overrides default display:none for .sub-menu */
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            /* No margin-top as it's part of the sub-menu */
        }

        .share-btn {
            background: linear-gradient(135deg, #8B7355 0%, #A0522D 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .share-btn.secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .no-book {
            text-align: center;
            color: #5d4e37;
            padding: 40px;
        }

        /* New Share Page Styles */
        #sharePage {
            display: none;
            /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 800px;
            padding-top: 20px;
            margin: 0 auto;
        }

        #sharePage.visible {
            display: flex;
        }

        .share-page-nav {
            width: 100%;
            margin-bottom: 20px;
            text-align: left;
        }

        .share-page-nav a {
            display: inline-flex;
            align-items: center;
            color: #8B7355;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .share-page-nav a:hover {
            color: #A0522D;
        }

        .share-page-nav a i {
            margin-right: 8px;
        }

        /* New style for the view-only heading */
        .view-only-heading {
            font-family: 'Inter', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: #5d4e37;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.3;
        }

        .share-page-heading {
            font-family: 'Inter', sans-serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: #5d4e37;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Share Content - Main Flex Container */
        .share-content {
            display: flex;
            flex-direction: column;
            /* Changed to column for top-bottom stacking */
            align-items: center;
            /* Center content horizontally */
            gap: 30px;
            /* Gap between book and new floating menu */
            width: 100%;
            max-width: 800px;
            /* Adjusted max-width for column layout */
            padding: 0;
            background: none;
            box-shadow: none;
            flex-wrap: wrap;
        }

        .share-book-preview {
            width: 100%;
            /* Take full width of parent */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 0;
            /* No padding here, book-container has its own */
        }

        /* New style for the floating share details wrapper */
        .share-details-wrapper {
            display: flex;
            flex-direction: row;
            /* Changed to row for side-by-side */
            align-items: center;
            /* Center items vertically */
            gap: 15px;
            /* Gap between input and button */
            margin-top: 20px;
            /* Space from the book */
            padding: 15px 25px;
            /* Match floating-menu padding */
            background: #fff;
            border-radius: 15px;
            /* Match floating-menu border-radius */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            /* Match floating-menu box-shadow */
            width: fit-content;
            /* Shrink to content */
            max-width: 600px;
            /* Increased max-width for side-by-side */
            flex-wrap: wrap;
            /* Allow wrapping on smaller screens */
            justify-content: center;
            /* Center content horizontally */
        }

        /* Adjusted input group for side-by-side */
        .share-input-group {
            flex-grow: 1;
            /* Allow input to take available space */
            display: flex;
            /* Ensure it's a flex container for its content */
            flex-direction: column;
            /* Keep label/input stacked if there were a label */
            width: auto;
            /* Allow width to be determined by flex-grow */
            min-width: 200px;
            /* Ensure a reasonable minimum width */
            gap: 0;
            /* No gap needed if label is removed */
        }

        .share-input-group input[type="text"] {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
            background: #f8f8f8;
            /* Added background to input */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            /* Subtle inner shadow */
            width: 100%;
            /* Take full width of its flex container */
        }

        .share-input-group input[type="text"]:focus {
            border-color: #A0522D;
            background: white;
        }

        .share-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            /* No width: 100% here, let it shrink to content */
        }

        /* Styling for the larger Copy Shareable Link button */
        .share-btn.copy-link-btn {
            padding: 12px 20px;
            /* Match main-menu-btn padding */
            font-size: 1rem;
            /* Match main-menu-btn font size */
            border-radius: 8px;
            /* Match main-menu-btn border-radius */
            background: linear-gradient(135deg, #A0522D 0%, #8B7355 100%);
            /* Keep original gradient */
            color: white;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            /* min-width: 180px; Removed, let it size based on content and padding */
            white-space: nowrap;
            /* Prevent text from wrapping */
        }

        .share-btn.copy-link-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        }

        /* Styles for view-only mode */
        .view-only-hidden {
            display: none !important;
        }

        /* Responsive adjustments for the new heading/tagline and grid */
        @media (max-width: 1024px) {
            .book-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                /* 3 columns on medium screens */
            }
        }

        @media (max-width: 768px) {
            .main-heading {
                font-size: 40px;
            }

            .tagline {
                font-size: 16px;
            }

            .book-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                /* 2 columns on tablets */
            }

            .book-grid .search-result-item img {
                width: 100px;
                height: 150px;
            }

            .customization-heading,
            .share-page-heading {
                font-size: 1.8rem;
            }

            .customization-subheading {
                font-size: 1rem;
            }

            .book-first-page {
                padding: 20px;
            }

            .main-menu-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
                min-width: 100px;
            }

            .font-btn,
            .sticker-btn,
            .share-btn {
                font-size: 12px;
                padding: 6px 12px;
            }

            .sticker-btn {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .share-content {
                flex-direction: column;
                /* Stack vertically on smaller screens */
                align-items: center;
                gap: 20px;
            }

            .share-book-preview,
            .share-details-wrapper {
                min-width: unset;
                /* Remove min-width on small screens */
                width: 100%;
                /* Take full width */
            }

            .share-book-preview {
                padding: 0;
                /* Remove padding if stacking */
            }

            .share-details-wrapper {
                flex-direction: column;
                /* Stack input and button vertically */
                padding: 15px;
                /* Adjust padding for smaller screens */
            }

            .share-input-group {
                width: 100%;
                /* Input takes full width when stacked */
            }

            .view-only-heading {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 480px) {
            .main-heading {
                font-size: 32px;
            }

            .tagline {
                font-size: 14px;
            }

            .book-grid {
                grid-template-columns: 1fr;
                /* 1 column on small mobiles */
            }

            .book-grid .search-result-item img {
                width: 100px;
                height: 150px;
            }

            .customization-heading,
            .share-page-heading {
                font-size: 1.5rem;
            }

            .customization-subheading {
                font-size: 0.9rem;
            }

            .note-input {
                padding: 15px;
            }

            .main-menu-btn {
                padding: 8px 15px;
                font-size: 0.85rem;
                min-width: 90px;
            }

            .font-selection-tools,
            .sticker-tools,
            .share-options {
                gap: 8px;
            }

            .view-only-heading {
                font-size: 1.2rem;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            color: #5d4e37;
        }

        .modal-content p {
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }

        .modal-btn.confirm-yes {
            background: #A0522D;
            color: white;
            border: none;
        }

        .modal-btn.confirm-yes:hover {
            background: #8B4513;
        }

        .modal-btn.confirm-no {
            background: #ddd;
            color: #5d4e37;
            border: 1px solid #ccc;
        }

        .modal-btn.confirm-no:hover {
            background: #ccc;
        }

        /* Tooltip styles */
        #copyTooltip {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            /* Allows clicks to pass through */
        }

        #copyTooltip.show {
            opacity: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Main Landing Page Content (First Page) -->
        <div id="mainLandingPage">
            <div class="text-center mb-10">
                <h1 class="main-heading">Send a Book with Love</h1>
                <p class="tagline">Want to recommend a book to someone special? Send it as a virtual gift with your
                    personal note and a delicate flower to make them smile</p>
            </div>

            <!-- Search Bar Section -->
            <div class="search-bar-section">
                <div class="flex items-center justify-center mb-4 search-input-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="searchInput"
                        placeholder="Search for a book title or author...">
                    <button class="clear-search-btn" id="clearSearchBtn" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Book Selection Section (for top books / search results) -->
            <div class="book-selection-section" id="bookSelectionSection">
                <h2 class="section-title" id="bookListTitle">Top Recommended Books</h2>
                <div id="bookDisplayGrid" class="book-grid">
                    <!-- Books (top recommended or search results) will be loaded here by JavaScript -->
                    <p class="text-gray-600 p-4">Loading books...</p>
                </div>
            </div>
        </div>

        <!-- Book Display Area (Second Page) - Initially hidden -->
        <div class="book-display-area" id="bookDisplayArea">
            <!-- Back to Search Navigation -->
            <div class="back-to-selection-nav">
                <a href="#" id="backToSelectionLink" class="back-nav-button">
                    <i class="fas fa-arrow-left"></i> Back to Book Selection
                </a>
            </div>

            <!-- Customization Page Heading -->
            <h2 class="customization-heading">Add a Personal Touch</h2>
            <!-- New Subheading -->
            <p class="customization-subheading">Personalize your gift with a message for the person you are sending this
                to.</p>

            <div class="book-container">
                <div class="book-model">
                    <!-- Book Spine (fixed part) -->
                    <div class="book-spine"></div>

                    <!-- The Stack of Pages (fixed part - the rest of the book) -->
                    <div class="book-pages-stack"></div>

                    <!-- Wrapper for the flipping cover -->
                    <div class="book-cover-wrapper" id="bookCoverWrapper">
                        <!-- Front Cover -->
                        <div class="book-cover-front" id="bookCoverFront">
                            <!-- Book cover image will be dynamically loaded here -->
                        </div>
                        <!-- Inside of the Front Cover -->
                        <div class="book-cover-inside" id="bookCoverInside">
                            <!-- A subtle image or text can go here, e.g., a faint watermark -->
                        </div>
                    </div>

                    <!-- First Page (where the note is scribbled) -->
                    <div class="book-first-page" id="bookFirstPage">
                        <div class="note-section">
                            <textarea class="note-input" id="noteInput" placeholder="Type here..."></textarea>
                            <div class="note-display" id="noteDisplay"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Floating Menu at the bottom of the book -->
            <div class="floating-menu">
                <!-- Sub-menus, hidden by default, appear above main buttons due to flex-direction: column-reverse -->
                <div class="sub-menu" id="fontSubMenu">
                    <div class="font-selection-tools">
                        <button class="font-btn active" data-font="Caveat">Caveat</button>
                        <button class="font-btn" data-font="Inter">Inter</button>
                        <button class="font-btn" data-font="Roboto">Roboto</button>
                        <button class="font-btn" data-font="Indie Flower">Indie Flower</button>
                        <button class="font-btn" data-font="Shadows Into Light">Shadows Into Light</button>
                    </div>
                </div>

                <div class="sub-menu" id="stickerSubMenu">
                    <div class="sticker-tools">
                        <button class="sticker-btn" data-sticker="🌸">🌸</button>
                        <button class="sticker-btn" data-sticker="🌻">🌻</button>
                        <button class="sticker-btn" data-sticker="🌼">🌼</button>
                        <button class="sticker-btn" data-sticker="🌹">🌹</button>
                        <button class="sticker-btn" data-sticker="🌷">🌷</button>
                    </div>
                </div>

                <div class="sub-menu" id="shareSubMenu">
                    <div class="share-options">
                        <button class="share-btn" onclick="window.bookApp.copyLink()">Copy Link</button>
                        <button class="share-btn" onclick="window.bookApp.sendEmail()">Email</button>
                        <button class="share-btn secondary" onclick="window.bookApp.shareSocial()">Share</button>
                    </div>
                </div>

                <div class="main-menu-buttons">
                    <button class="main-menu-btn" id="fontMenuBtn">
                        Aa Select Font
                    </button>
                    <button class="main-menu-btn" id="stickerMenuBtn">
                        <i class="fas fa-magic"></i> Add Sticker
                    </button>
                    <button class="main-menu-btn" id="shareMenuBtn">
                        <span class="material-icons">share</span> Share
                    </button>
                </div>
            </div> <!-- End floating-menu -->

        </div> <!-- End book-display-area -->

        <!-- Share Page - Initially hidden -->
        <div id="sharePage">
            <div class="share-page-nav">
                <a href="#" id="backToEditingLink">
                    <i class="fas fa-arrow-left"></i> Back to Editing
                </a>
            </div>

            <!-- New View-Only Heading (conditionally displayed) -->
            <h2 class="view-only-heading" id="viewOnlyHeading" style="display: none;"></h2>
            <!-- Original Share Page Heading (conditionally displayed) -->
            <h2 class="share-page-heading" id="sharePageOriginalHeading">Share with a Loved One</h2>

            <div class="share-content">
                <div class="share-book-preview">
                    <!-- Replicated book container for preview -->
                    <div class="book-container">
                        <div class="book-model">
                            <div class="book-spine"></div>
                            <div class="book-pages-stack"></div>
                            <div class="book-cover-wrapper" id="shareBookCoverWrapper">
                                <div class="book-cover-front" id="shareBookCoverFront"></div>
                                <div class="book-cover-inside" id="shareBookCoverInside"></div>
                            </div>
                            <div class="book-first-page" id="shareBookFirstPage">
                                <div class="note-section">
                                    <div class="note-display" id="shareNoteDisplay"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New wrapper for name input and share actions - now a floating menu -->
                <div class="share-details-wrapper" id="shareDetailsWrapper">
                    <div class="share-input-group">
                        <!-- Label removed, text moved to placeholder -->
                        <input type="text" id="senderName" placeholder="Your Name (optional)">
                    </div>

                    <div class="share-actions">
                        <button class="share-btn copy-link-btn" onclick="window.bookApp.copyShareableLink()">Copy
                            Shareable Link</button>
                    </div>
                </div>
            </div>
        </div> <!-- End sharePage -->

        <!-- Tooltip Element -->
        <div id="copyTooltip">Link copied to clipboard!</div>


        <script type="module">
            // Firebase Imports
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, getDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            // Global variables for Canvas environment. These will be undefined when run locally.
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // Firebase configuration for local testing.
            // IMPORTANT: Replace these with your actual Firebase project configuration.
            // You can find this in your Firebase project settings -> "Your apps" -> Web app -> "Config"
            const localFirebaseConfig = {
                apiKey: "AIzaSyCSVx_kO5BihsOLuBgpxD_WUVPRy_NiWb0",
                authDomain: "bookrec-d5c37.firebaseapp.com",
                projectId: "bookrec-d5c37",
                storageBucket: "bookrec-d5c37.firebasestorage.app",
                messagingSenderId: "420099286541",
                appId: "1:420099286541:web:854ad158f71ee365d69744",
                measurementId: "G-81QZERBNM8"
            };

            // Use the Canvas provided config if available, otherwise use the local config
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : localFirebaseConfig;

            // Declare bookApp globally
            window.bookApp;

            class BookApp {
                constructor () {
                    // Firebase Initialization
                    this.app = initializeApp(firebaseConfig);
                    this.db = getFirestore(this.app);
                    this.auth = getAuth(this.app);
                    this.userId = null; // Will be set after authentication

                    // Initialize initialAuthToken here, making it a property of the class
                    this.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                    // Main Landing Page Container
                    this.mainLandingPage = document.getElementById('mainLandingPage');

                    // Book Selection Section Elements (repurposed from search)
                    this.bookSelectionSection = document.getElementById('bookSelectionSection');
                    this.bookDisplayGrid = document.getElementById('bookDisplayGrid'); // This will hold both top books and search results
                    this.bookListTitle = document.getElementById('bookListTitle'); // New element for dynamic title

                    // Search Bar Elements
                    this.searchInput = document.getElementById('searchInput');
                    this.clearSearchBtn = document.getElementById('clearSearchBtn'); // New clear button

                    // Book Display Elements (Customization Page)
                    this.bookDisplayArea = document.getElementById('bookDisplayArea');
                    this.bookCoverWrapper = document.getElementById('bookCoverWrapper'); // Customization page book wrapper
                    this.bookCoverFront = document.getElementById('bookCoverFront');
                    this.bookCoverInside = document.getElementById('bookCoverInside');
                    this.bookFirstPage = document.getElementById('bookFirstPage');
                    this.noteInput = document.getElementById('noteInput');
                    this.noteDisplay = document.getElementById('noteDisplay');
                    this.stickerContainer = this.bookFirstPage; // Stickers go directly on the first page

                    // Floating Menu Elements
                    this.fontMenuBtn = document.getElementById('fontMenuBtn');
                    this.stickerMenuBtn = document.getElementById('stickerMenuBtn');
                    this.shareMenuBtn = document.getElementById('shareMenuBtn');

                    this.fontSubMenu = document.getElementById('fontSubMenu');
                    this.stickerSubMenu = document.getElementById('stickerSubMenu');
                    this.shareSubMenu = document.getElementById('shareSubMenu');

                    this.fontButtons = document.querySelectorAll('#fontSubMenu .font-btn'); // Select font buttons within sub-menu
                    this.stickerButtons = document.querySelectorAll('#stickerSubMenu .sticker-btn'); // Select sticker buttons within sub-menu

                    // Share Page Elements
                    this.sharePage = document.getElementById('sharePage');
                    this.backToEditingLink = document.getElementById('backToEditingLink');
                    this.shareBookCoverWrapper = document.getElementById('shareBookCoverWrapper'); // Share page book wrapper
                    this.shareBookCoverFront = document.getElementById('shareBookCoverFront');
                    this.shareBookCoverInside = document.getElementById('shareBookCoverInside'); // Corrected reference
                    this.shareBookFirstPage = document.getElementById('shareBookFirstPage');
                    this.shareNoteDisplay = document.getElementById('shareNoteDisplay');
                    this.senderNameInput = document.getElementById('senderName');
                    this.viewOnlyHeading = document.getElementById('viewOnlyHeading'); // New view-only heading
                    this.sharePageOriginalHeading = document.getElementById('sharePageOriginalHeading'); // Original heading
                    this.shareDetailsWrapper = document.getElementById('shareDetailsWrapper'); // Wrapper for sender name and copy button
                    this.copyTooltip = document.getElementById('copyTooltip'); // Tooltip element

                    // Modal Elements (These are not currently used for back navigation but are kept in the code)
                    this.confirmationModal = document.getElementById('confirmationModal');
                    this.confirmYesBtn = document.getElementById('confirmYes');
                    this.confirmNoBtn = document.getElementById('confirmNo');

                    // This is the one the user specifically asked about.
                    this.backToSelectionLink = document.getElementById('backToSelectionLink');


                    this.selectedBook = null;
                    this.stickers = []; // Stores sticker data {emoji, element}
                    this.isBookOpen = false; // For customization page book
                    this.isShareBookOpen = false; // For share page book
                    this.searchTimeout = null; // For debouncing search input
                    this.isViewOnlyMode = false; // New state to track view-only mode

                    this.init();
                }

                async init () {
                    // Authenticate with Firebase first
                    try
                    {
                        if (this.initialAuthToken)
                        {
                            await signInWithCustomToken(this.auth, this.initialAuthToken);
                        } else
                        {
                            await signInAnonymously(this.auth);
                        }
                        this.userId = this.auth.currentUser?.uid || crypto.randomUUID();
                        console.log("Firebase authenticated. User ID:", this.userId);
                    } catch (error)
                    {
                        console.error("Firebase authentication failed:", error);
                    }

                    this.setupEventListeners();

                    const urlParams = new URLSearchParams(window.location.search);
                    const viewId = urlParams.get('view');

                    if (viewId)
                    {
                        this.isViewOnlyMode = true;
                        this.loadViewOnlyBook(viewId);
                    } else
                    {
                        this.isViewOnlyMode = false;
                        // If not in view-only mode, always start on the main landing page
                        this.showMainLandingPage();
                        // No longer calling loadBookData() here, as that was causing the automatic navigation
                        // to the customize page if a book was previously saved in local storage.
                        // The user explicitly wants to start with the search page.
                    }

                    // Load saved note and stickers (only in customization mode)
                    // This call needs to be outside the if/else for viewId,
                    // but its effects should only apply when the customization page is active.
                    // The current `loadSavedData` already checks `!this.isViewOnlyMode` within itself,
                    // so it's fine where it is.
                    if (!this.isViewOnlyMode)
                    {
                        this.loadSavedData();
                    }
                }

                setupEventListeners () {
                    // Helper to safely add event listeners
                    const addListener = (element, event, handler) => {
                        if (element)
                        {
                            element.addEventListener(event, handler);
                        } else
                        {
                            // Removed previous console.warn messages as they are no longer needed
                        }
                    };

                    // Search functionality
                    addListener(this.searchInput, 'input', () => this.handleSearchInput()); // Use 'input' for dynamic search
                    addListener(this.clearSearchBtn, 'click', () => this.clearSearch());

                    // Book interaction (Customization Page)
                    addListener(this.bookCoverFront, 'click', () => this.openBook());

                    // Note input (auto-save/display)
                    addListener(this.noteInput, 'input', () => this.saveNote(this.noteInput.value));
                    addListener(this.noteInput, 'blur', () => this.showNoteDisplay(this.noteInput.value)); // Show display on blur
                    addListener(this.noteDisplay, 'click', () => this.editNote()); // Click display to edit

                    // Floating Menu Main Buttons (hidden in view-only mode)
                    if (!this.isViewOnlyMode)
                    {
                        addListener(this.fontMenuBtn, 'click', (e) => {
                            e.stopPropagation(); // Prevent document click from immediately closing
                            this.toggleSubMenu(this.fontSubMenu);
                        });
                        addListener(this.stickerMenuBtn, 'click', (e) => {
                            e.stopPropagation(); // Prevent document click from immediately closing
                            this.toggleSubMenu(this.stickerSubMenu);
                        });
                        addListener(this.shareMenuBtn, 'click', (e) => {
                            e.stopPropagation(); // Prevent document click from immediately closing
                            this.showSharePage(); // Direct to share page
                        });

                        // Sticker buttons
                        this.stickerButtons.forEach(btn => {
                            addListener(btn, 'click', () => this.addSticker(btn.dataset.sticker));
                        });

                        // Font selection buttons
                        this.fontButtons.forEach(button => {
                            addListener(button, 'click', (e) => {
                                this.setFont(e.target.dataset.font);
                                this.fontSubMenu.classList.remove('visible'); // Close font menu after selection
                            });
                        });
                    } else
                    {
                        // Hide customization controls if in view-only mode
                        document.querySelectorAll('.floating-menu, .customization-heading, .customization-subheading, .back-to-selection-nav').forEach(el => {
                            if (el) el.classList.add('view-only-hidden');
                        });
                        // Hide sender name input and copy button on share page in view-only mode
                        if (this.shareDetailsWrapper) this.shareDetailsWrapper.classList.add('view-only-hidden');
                        if (this.sharePageOriginalHeading) this.sharePageOriginalHeading.classList.add('view-only-hidden');
                    }

                    // Back to Book Selection navigation button
                    addListener(this.backToSelectionLink, 'click', (e) => {
                        e.preventDefault();
                        this.performBackToSearch();
                    });

                    // Share Page Navigation (back to editing)
                    addListener(this.backToEditingLink, 'click', (e) => {
                        e.preventDefault();
                        this.showBookDisplayArea();
                    });

                    // Share Page Book Interaction (always active)
                    addListener(this.shareBookCoverFront, 'click', () => this.toggleShareBook()); // This correctly maps to the share page book
                    addListener(this.shareBookCoverInside, 'click', () => this.toggleShareBook()); // Also allow tapping inside cover
                    addListener(this.shareBookFirstPage, 'click', () => this.toggleShareBook()); // Added tap for first page

                    // Close sub-menus when clicking outside (only relevant in customization mode)
                    if (!this.isViewOnlyMode)
                    {
                        addListener(document, 'click', (e) => {
                            // Check if the click target is NOT one of the main menu buttons
                            const isMainMenuButton = e.target.closest('.main-menu-btn');
                            // Check if the click target is NOT inside any of the sub-menus
                            const isInsideSubMenu = e.target.closest('.sub-menu');

                            if (!isMainMenuButton && !isInsideSubMenu)
                            {
                                this.fontSubMenu.classList.remove('visible');
                                this.stickerSubMenu.classList.remove('visible');
                            }
                        });
                    }

                    // Modal buttons (these are not currently used for back navigation but are kept in the code)
                    // addListener(this.confirmYesBtn, 'click', () => this.confirmAbandonNotes(true));
                    // addListener(this.confirmNoBtn, 'click', () => this.confirmAbandonNotes(false));

                    // Load saved note and stickers (only in customization mode)
                    if (!this.isViewOnlyMode)
                    {
                        this.loadSavedData();
                    }
                }

                // --- Sub-menu toggle logic ---
                toggleSubMenu (targetSubMenu) {
                    // Close all other sub-menus
                    [this.fontSubMenu, this.stickerSubMenu].forEach(menu => { // Only close font and sticker menus
                        if (menu !== targetSubMenu && menu.classList.contains('visible'))
                        {
                            menu.classList.remove('visible');
                        }
                    });
                    // Toggle visibility of the target sub-menu
                    targetSubMenu.classList.toggle('visible');
                }

                // --- Search and Book Display Logic ---

                handleSearchInput () {
                    clearTimeout(this.searchTimeout); // Clear previous timeout
                    const query = this.searchInput.value.trim();
                    if (query.length > 0)
                    {
                        if (this.clearSearchBtn) this.clearSearchBtn.style.display = 'block'; // Show clear button
                        this.searchTimeout = setTimeout(() => {
                            this.performSearch(query);
                        }, 500); // Debounce for 500ms
                    } else
                    {
                        if (this.clearSearchBtn) this.clearSearchBtn.style.display = 'none'; // Hide clear button
                        this.clearSearch(); // Clear results and show top books if input is empty
                    }
                }

                clearSearch () {
                    if (this.searchInput) this.searchInput.value = '';
                    if (this.clearSearchBtn) this.clearSearchBtn.style.display = 'none';
                    if (this.bookListTitle) this.bookListTitle.textContent = 'Top Recommended Books';
                    this.fetchTopBooks(); // Reload top books
                }

                async performSearch (query) {
                    if (this.bookListTitle) this.bookListTitle.textContent = 'Searching...';
                    if (this.bookDisplayGrid) this.bookDisplayGrid.innerHTML = `<p class="loading-indicator">Searching for books...</p>`;
                    const apiKey = "";
                    const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=${ encodeURIComponent(query) }&maxResults=20&key=${ apiKey }`; // Fetch more results for search

                    try
                    {
                        const response = await fetch(apiUrl);
                        if (!response.ok)
                        {
                            throw new Error(`HTTP error! status: ${ response.status }`);
                        }
                        const data = await response.json();
                        const items = data.items || [];
                        this.displayBooks(items);
                        if (this.bookListTitle) this.bookListTitle.textContent = `${ items.length } results found`;
                    } catch (error)
                    {
                        console.error("Error fetching books:", error);
                        if (this.bookDisplayGrid) this.bookDisplayGrid.innerHTML = `<p class="text-red-500 p-4 text-center">Failed to load search results. Please try again.</p>`;
                        if (this.bookListTitle) this.bookListTitle.textContent = 'Search Failed';
                    }
                }

                async fetchTopBooks () {
                    if (this.bookListTitle) this.bookListTitle.textContent = 'Top Recommended Books';
                    if (this.bookDisplayGrid) this.bookDisplayGrid.innerHTML = `<p class="loading-indicator">Loading top books...</p>`;
                    // Using a general query to simulate "top rated" or "bestsellers"
                    const apiKey = "";
                    const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=bestsellers fiction&maxResults=12&key=${ apiKey }`;

                    try
                    {
                        const response = await fetch(apiUrl);
                        if (!response.ok)
                        {
                            throw new Error(`HTTP error! status: ${ response.status }`);
                        }
                        const data = await response.json();
                        const items = data.items || [];
                        this.displayBooks(items);
                    } catch (error)
                    {
                        console.error("Error fetching top books:", error);
                        if (this.bookDisplayGrid) this.bookDisplayGrid.innerHTML = `<p class="text-red-500 p-4 text-center">Failed to load top books. Please try again.</p>`;
                    }
                }

                displayBooks (items) {
                    if (this.bookDisplayGrid) this.bookDisplayGrid.innerHTML = ''; // Clear existing content
                    if (items.length > 0)
                    {
                        items.forEach(item => {
                            const volumeInfo = item.volumeInfo;
                            const title = volumeInfo.title || 'No Title';
                            const authors = volumeInfo.authors ? volumeInfo.authors.join(', ') : 'Unknown Author';
                            // Prioritize extraLarge, then large, then medium, then thumbnail for higher resolution
                            const coverUrl = volumeInfo.imageLinks ? (
                                volumeInfo.imageLinks.extraLarge ||
                                volumeInfo.imageLinks.large ||
                                volumeInfo.imageLinks.medium ||
                                volumeInfo.imageLinks.thumbnail
                            ) : 'https://placehold.co/120x180/cccccc/ffffff?text=No+Cover';

                            const book = {
                                id: item.id,
                                title: title,
                                author: authors,
                                coverUrl: coverUrl
                            };

                            const bookItem = document.createElement('div');
                            bookItem.className = 'search-result-item'; // Reusing existing styling for grid items

                            bookItem.innerHTML = `
                            <img src="${ book.coverUrl }" alt="${ book.title } cover" onerror="this.onerror=null;this.src='https://placehold.co/120x180/cccccc/ffffff?text=No+Cover';">
                            <div class="search-result-info">
                                <h4>${ book.title }</h4>
                                <p>by ${ book.author }</p>
                            </div>
                        `;
                            bookItem.addEventListener('click', () => this.selectBook(book));
                            if (this.bookDisplayGrid) this.bookDisplayGrid.appendChild(bookItem);
                        });
                    } else
                    {
                        if (this.bookDisplayGrid) this.bookDisplayGrid.innerHTML = `<p class="text-gray-600 p-4 text-center">No books found.</p>`;
                        // If no search results, restore "Top Recommended Books" title
                        if (this.searchInput && this.searchInput.value.trim() !== '')
                        {
                            if (this.bookListTitle) this.bookListTitle.textContent = '0 results found';
                        } else
                        {
                            if (this.bookListTitle) this.bookListTitle.textContent = 'Top Recommended Books';
                        }
                    }
                }

                selectBook (book) {
                    this.selectedBook = book;
                    localStorage.setItem('selectedBook', JSON.stringify(book)); // Save selected book
                    this.displayBook(this.bookCoverFront, this.bookCoverInside); // Display on customization page
                    this.showBookDisplayArea(); // Show the book customization area
                    // Auto-open the book once selected, after a slight delay for visual transition
                    setTimeout(() => {
                        this.openBook();
                    }, 300);
                }

                loadBookData () {
                    const bookData = localStorage.getItem('selectedBook');
                    if (bookData)
                    {
                        this.selectedBook = JSON.parse(bookData);
                        this.displayBook(this.bookCoverFront, this.bookCoverInside); // Display on customization page
                        this.showBookDisplayArea(); // Show book if one is already selected
                        // Auto-open if a book is already loaded, after a slight delay
                        setTimeout(() => {
                            this.openBook();
                        }, 300);
                    } else
                    {
                        this.showMainLandingPage(); // Show the main landing page if no book is selected
                    }
                }

                // Reusable function to display book cover on a given element
                displayBook (frontCoverElement, insideCoverElement) {
                    if (!frontCoverElement)
                    {
                        console.warn("frontCoverElement is null or undefined.");
                        return;
                    }

                    // Define a default placeholder URL
                    const defaultPlaceholderUrl = 'https://placehold.co/300x450/8B7355/ffffff?text=No+Cover';
                    let imageUrl = defaultPlaceholderUrl; // Start with the default
                    let imageAlt = 'No Cover Available';

                    // If a book is selected and it.selectedBook has a coverUrl, use it
                    if (this.selectedBook && this.selectedBook.coverUrl)
                    {
                        imageUrl = this.selectedBook.coverUrl;
                        imageAlt = `${ this.selectedBook.title } cover`;
                    }

                    // Log the URL being set for debugging
                    console.log(`Attempting to load cover image: ${ imageUrl } for element:`, frontCoverElement.id);

                    // Set the front cover using the determined imageUrl
                    frontCoverElement.innerHTML = `
                    <img src="${ imageUrl }" alt="${ imageAlt }" onerror="this.onerror=null;this.src='${ defaultPlaceholderUrl }';">
                `;

                    // Set the background image for the inside cover
                    if (insideCoverElement)
                    {
                        insideCoverElement.style.backgroundImage = `url('${ imageUrl }')`;
                        // No need to clear innerHTML, as we are using background-image
                    }
                }

                // New methods to toggle visibility of main landing page, book display area, and share page
                showMainLandingPage () {
                    if (this.mainLandingPage) this.mainLandingPage.style.display = 'flex';
                    if (this.bookDisplayArea) this.bookDisplayArea.style.display = 'none';
                    if (this.sharePage) this.sharePage.style.display = 'none';
                    this.fetchTopBooks(); // Ensure top books are fetched when returning to landing page
                }

                showBookDisplayArea () {
                    if (this.mainLandingPage) this.mainLandingPage.style.display = 'none';
                    if (this.bookDisplayArea) this.bookDisplayArea.style.display = 'flex';
                    if (this.sharePage) this.sharePage.style.display = 'none';
                    this.closeShareBook(); // Ensure share page book is closed when returning
                }

                showSharePage () {
                    if (this.mainLandingPage) this.mainLandingPage.style.display = 'none';
                    if (this.bookDisplayArea) this.bookDisplayArea.style.display = 'none';
                    if (this.sharePage) this.sharePage.style.display = 'flex';

                    // Reset share page visibility elements
                    if (this.viewOnlyHeading) this.viewOnlyHeading.style.display = 'none';
                    if (this.sharePageOriginalHeading) this.sharePageOriginalHeading.style.display = 'block';
                    if (this.shareDetailsWrapper) this.shareDetailsWrapper.classList.remove('view-only-hidden');

                    // Explicitly hide the first page of the share book initially
                    if (this.shareBookFirstPage)
                    {
                        this.shareBookFirstPage.style.opacity = '0';
                        this.shareBookFirstPage.style.pointerEvents = 'none';
                        // Also ensure the 'open' class is removed from the wrapper and model
                        if (this.shareBookCoverWrapper) this.shareBookCoverWrapper.classList.remove('open');
                        const shareBookModel = document.querySelector('#sharePage .book-model');
                        if (shareBookModel) shareBookModel.classList.remove('open');
                        this.isShareBookOpen = false; // Reset state
                    }

                    // Update book preview on share page with current customization
                    this.displayBook(this.shareBookCoverFront, this.shareBookCoverInside);
                    this.shareNoteDisplay.textContent = this.noteInput.value;
                    this.shareNoteDisplay.style.fontFamily = this.noteInput.style.fontFamily;
                    this.shareNoteDisplay.style.fontSize = this.noteInput.style.fontSize;
                    this.shareNoteDisplay.classList.add('visible'); // Ensure it's visible

                    // Clear existing stickers on the share book preview
                    const currentShareStickers = this.shareBookFirstPage.querySelectorAll('.sticker');
                    currentShareStickers.forEach(sticker => sticker.remove());

                    // Re-add stickers to the share book preview
                    this.stickers.forEach(sData => {
                        const sticker = document.createElement('div');
                        sticker.className = 'sticker';
                        sticker.style.position = 'absolute';
                        sticker.innerHTML = `
                        <span class="sticker-emoji" style="font-size: ${ sData.fontSize }px;">${ sData.emoji }</span>
                    `;
                        sticker.style.left = sData.left + 'px'; // Ensure 'px' unit
                        sticker.style.top = sData.top + 'px';   // Ensure 'px' unit
                        this.shareBookFirstPage.appendChild(sticker);
                    });

                    // Close any open sub-menus from the customization page
                    this.fontSubMenu.classList.remove('visible');
                    this.stickerSubMenu.classList.remove('visible');
                }

                openBook () {
                    if (!this.isBookOpen && this.bookCoverWrapper)
                    {
                        this.bookCoverWrapper.classList.add('open');
                        // Get the book-model element within bookDisplayArea
                        const bookModel = document.querySelector('#bookDisplayArea .book-model');
                        if (bookModel)
                        {
                            bookModel.classList.add('open');
                        }
                        this.isBookOpen = true;
                    }
                }

                closeBook () {
                    if (this.isBookOpen && this.bookCoverWrapper)
                    {
                        this.bookCoverWrapper.classList.remove('open');
                        // Get the book-model element within bookDisplayArea
                        const bookModel = document.querySelector('#bookDisplayArea .book-model');
                        if (bookModel)
                        {
                            bookModel.classList.remove('open');
                        }
                        this.isBookOpen = false;
                    }
                }

                toggleShareBook () {
                    if (this.shareBookCoverWrapper)
                    {
                        this.shareBookCoverWrapper.classList.toggle('open');
                        // Get the book-model element within sharePage
                        const shareBookModel = document.querySelector('#sharePage .book-model');
                        if (shareBookModel)
                        {
                            shareBookModel.classList.toggle('open');
                        }
                        this.isShareBookOpen = !this.isShareBookOpen;
                    }
                }

                closeShareBook () {
                    if (this.isShareBookOpen && this.shareBookCoverWrapper)
                    {
                        this.shareBookCoverWrapper.classList.remove('open');
                        // Get the book-model element within sharePage
                        const shareBookModel = document.querySelector('#sharePage .book-model');
                        if (shareBookModel)
                        {
                            shareBookModel.classList.remove('open');
                        }
                        this.isShareBookOpen = false;
                    }
                }

                saveNote (note) {
                    localStorage.setItem('bookNote', note);
                }

                showNoteDisplay (note) {
                    if (this.noteDisplay && this.noteInput)
                    {
                        if (note.trim() === '')
                        { // If note is empty, keep input visible
                            this.noteInput.style.display = 'block';
                            this.noteDisplay.classList.remove('visible');
                            this.noteDisplay.textContent = ''; // Clear display if no note
                        } else
                        { // If note has content, show display
                            this.noteDisplay.textContent = note;
                            this.noteDisplay.classList.add('visible');
                            this.noteInput.style.display = 'none';
                        }
                    }
                }

                editNote () {
                    if (this.noteInput)
                    {
                        this.noteInput.style.display = 'block';
                        this.noteInput.focus(); // Focus on input when editing
                    }
                    if (this.noteDisplay) this.noteDisplay.classList.remove('visible');
                }

                // New method to set font
                setFont (fontFamily) {
                    if (this.noteInput)
                    {
                        this.noteInput.style.fontFamily = `'${ fontFamily }'`;
                    }
                    if (this.noteDisplay)
                    {
                        this.noteDisplay.style.fontFamily = `'${ fontFamily }'`;
                    }
                    if (this.shareNoteDisplay)
                    { // Also update share page note display
                        this.shareNoteDisplay.style.fontFamily = `'${ fontFamily }'`;
                    }

                    // Update active state for font buttons
                    this.fontButtons.forEach(button => {
                        if (button.dataset.font === fontFamily)
                        {
                            button.classList.add('active');
                        } else
                        {
                            button.classList.remove('active');
                        }
                    });
                }

                addSticker (emoji) {
                    const sticker = document.createElement('div');
                    sticker.className = 'sticker';
                    sticker.style.position = 'absolute';
                    sticker.innerHTML = `
                    <span class="sticker-emoji">${ emoji }</span>
                    <button class="sticker-remove">✕</button>
                    <button class="sticker-resize">⤢</button>
                `;

                    // Append sticker first to get its rendered dimensions
                    if (this.bookFirstPage) this.bookFirstPage.appendChild(sticker);

                    // Calculate initial position to center it
                    const parentRect = this.bookFirstPage.getBoundingClientRect();
                    const stickerWidth = sticker.offsetWidth;
                    const stickerHeight = sticker.offsetHeight;

                    sticker.style.left = `${ (parentRect.width / 2) - (stickerWidth / 2) }px`;
                    sticker.style.top = `${ (parentRect.height / 2) - (stickerHeight / 2) }px`;

                    this.makeDraggable(sticker);
                    this.makeResizable(sticker); // Directly call makeResizable here
                    this.setupStickerControls(sticker); // This will only set up remove button now

                    this.stickers.push({
                        emoji: emoji,
                        // Store position and size directly for persistence
                        left: parseFloat(sticker.style.left),
                        top: parseFloat(sticker.style.top),
                        fontSize: parseFloat(window.getComputedStyle(sticker.querySelector('.sticker-emoji')).fontSize),
                        element: sticker // Keep reference to element for live manipulation
                    });
                    this.stickerSubMenu.classList.remove('visible'); // Close sticker menu after adding
                }

                makeDraggable (element) {
                    let isDragging = false;
                    let offsetX, offsetY; // Offset of mouse from element's top-left corner

                    const dragHandler = (e) => {
                        // Only prevent default if it's a drag, not a control click
                        if (e.target.classList.contains('sticker-remove') ||
                            e.target.classList.contains('sticker-resize'))
                        {
                            return;
                        }

                        e.preventDefault();
                        isDragging = true;
                        element.classList.add('dragging');

                        // Get the bounding rectangle of the sticker
                        const rect = element.getBoundingClientRect();
                        // Get the bounding rectangle of the parent (bookFirstPage)
                        const parentRect = element.parentElement.getBoundingClientRect();

                        let clientX, clientY;
                        if (e.type === 'mousedown')
                        {
                            clientX = e.clientX;
                            clientY = e.clientY;
                        } else
                        {
                            clientX = e.touches[0].clientX;
                            clientY = e.touches[0].clientY;
                        }

                        // Calculate the offset of the mouse pointer relative to the sticker's current position
                        // This ensures the sticker doesn't "jump" when dragging starts
                        offsetX = clientX - rect.left;
                        offsetY = clientY - rect.top;

                        // Bind move and up events to document to handle dragging outside the element
                        document.addEventListener('mousemove', moveHandler);
                        document.addEventListener('touchmove', moveHandler);
                        document.addEventListener('mouseup', stopHandler);
                        document.addEventListener('touchend', stopHandler);
                    };

                    const moveHandler = (e) => {
                        if (isDragging)
                        {
                            e.preventDefault();

                            let clientX, clientY;
                            if (e.type === 'mousemove')
                            {
                                clientX = e.clientX;
                                clientY = e.clientY;
                            } else
                            {
                                clientX = e.touches[0].clientX;
                                clientY = e.touches[0].clientY;
                            }

                            const parentRect = element.parentElement.getBoundingClientRect();
                            const stickerWidth = element.offsetWidth;
                            const stickerHeight = element.offsetHeight;

                            // Calculate new position relative to the parent's top-left
                            let newX = clientX - parentRect.left - offsetX;
                            let newY = clientY - parentRect.top - offsetY;

                            // Apply boundaries to keep sticker within parent
                            newX = Math.max(0, Math.min(newX, parentRect.width - stickerWidth));
                            newY = Math.max(0, Math.min(newY, parentRect.height - stickerHeight));

                            element.style.left = `${ newX }px`;
                            element.style.top = `${ newY }px`;

                            // Update the stored position for persistence
                            const stickerData = this.stickers.find(s => s.element === element);
                            if (stickerData)
                            {
                                stickerData.left = newX;
                                stickerData.top = newY;
                            }
                        }
                    };

                    const stopHandler = () => {
                        isDragging = false;
                        element.classList.remove('dragging');
                        document.removeEventListener('mousemove', moveHandler);
                        document.removeEventListener('touchmove', moveHandler);
                        document.removeEventListener('mouseup', stopHandler);
                        document.removeEventListener('touchend', stopHandler);
                    };

                    element.addEventListener('mousedown', dragHandler);
                    element.addEventListener('touchstart', dragHandler);
                }

                makeResizable (element) {
                    const resizeBtn = element.querySelector('.sticker-resize');
                    const stickerEmoji = element.querySelector('.sticker-emoji');
                    let isResizing = false;
                    let initialX, initialY; // Mouse/touch coordinates when resize starts
                    let initialSize;        // Initial font-size of the emoji

                    if (!resizeBtn || !stickerEmoji) return;

                    const resizeHandler = (e) => {
                        e.stopPropagation(); // Prevent dragging the sticker itself
                        e.preventDefault(); // Prevent default browser actions (e.g., text selection)

                        isResizing = true;
                        element.classList.add('resizing'); // Add a class for visual feedback if needed

                        if (e.type === 'mousedown')
                        {
                            initialX = e.clientX;
                            initialY = e.clientY;
                        } else
                        {
                            initialX = e.touches[0].clientX;
                            initialY = e.touches[0].clientY;
                        }

                        initialSize = parseFloat(window.getComputedStyle(stickerEmoji).fontSize);

                        document.addEventListener('mousemove', moveHandler);
                        document.addEventListener('touchmove', moveHandler);
                        document.addEventListener('mouseup', stopHandler);
                        document.addEventListener('touchend', stopHandler);
                    };

                    const moveHandler = (e) => {
                        if (!isResizing) return;
                        e.preventDefault(); // Prevent scrolling on touch devices

                        let clientX, clientY;
                        if (e.type === 'mousemove')
                        {
                            clientX = e.clientX;
                            clientY = e.clientY;
                        } else
                        {
                            clientX = e.touches[0].clientX;
                            clientY = e.touches[0].clientY;
                        }

                        // Calculate change in position from initial point
                        // We want to scale based on distance from the sticker's center or its top-left,
                        // but for a bottom-right handle, it's simpler to use delta from initial mouse position.
                        // The resize direction is diagonal (nwse-resize cursor).
                        // Dragging right/down increases, dragging left/up decreases.

                        const deltaX = clientX - initialX;
                        const deltaY = clientY - initialY;

                        // Combine deltas for diagonal resizing. A simple sum or average works for scaling.
                        // Adjust sensitivity with a multiplier.
                        const scaleFactor = (deltaX + deltaY) * 0.2;

                        let newSize = initialSize + scaleFactor;

                        // Apply minimum and maximum size constraints
                        const minSize = 20; // Minimum font size
                        const maxSize = 70; // Maximum font size
                        newSize = Math.max(minSize, Math.min(newSize, maxSize));

                        stickerEmoji.style.fontSize = `${ newSize }px`;

                        // Update the stored font size for persistence
                        const stickerData = this.stickers.find(s => s.element === element);
                        if (stickerData)
                        {
                            stickerData.fontSize = newSize;
                        }
                    };

                    const stopHandler = () => {
                        isResizing = false;
                        element.classList.remove('resizing');
                        document.removeEventListener('mousemove', moveHandler);
                        document.removeEventListener('touchmove', moveHandler);
                        document.removeEventListener('mouseup', stopHandler);
                        document.removeEventListener('touchend', stopHandler);
                    };

                    resizeBtn.addEventListener('mousedown', resizeHandler);
                    resizeBtn.addEventListener('touchstart', resizeHandler);
                }

                setupStickerControls (sticker) {
                    const removeBtn = sticker.querySelector('.sticker-remove');
                    // The resizeBtn is now handled by makeResizable directly
                    // const resizeBtn = sticker.querySelector('.sticker-resize'); 

                    if (removeBtn) removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent drag from starting
                        sticker.remove();
                        this.stickers = this.stickers.filter(s => s.element !== sticker);
                    });
                }

                loadSavedData () {
                    const savedNote = localStorage.getItem('bookNote');
                    // Call showNoteDisplay, which now handles visibility based on content
                    this.showNoteDisplay(savedNote || ''); // Pass empty string if no saved note
                    // Set initial font to Caveat (or default)
                    this.setFont('Caveat');
                }

                // Actual function to go back to search
                performBackToSearch () {
                    console.log("performBackToSearch called.");
                    // Clear selected book and note from local storage
                    localStorage.removeItem('selectedBook');
                    localStorage.removeItem('bookNote');
                    this.selectedBook = null; // Also clear the instance variable
                    console.log("Local storage and selectedBook cleared.");

                    // Instantly hide the current book display area and show the main landing page
                    if (this.bookDisplayArea)
                    {
                        this.bookDisplayArea.style.display = 'none';
                        console.log("bookDisplayArea display set to none.");
                    }
                    if (this.mainLandingPage)
                    {
                        this.mainLandingPage.style.display = 'flex'; // Ensure it's flex for its internal layout
                        console.log("mainLandingPage display set to flex.");
                    }

                    // Re-fetch top books for the landing page (showMainLandingPage already calls this)
                    this.fetchTopBooks();
                    console.log("fetchTopBooks called.");

                    // Ensure the book on the customization page is closed visually (without animation)
                    if (this.isBookOpen && this.bookCoverWrapper)
                    {
                        this.bookCoverWrapper.classList.remove('open');
                        const bookModel = document.querySelector('#bookDisplayArea .book-model');
                        if (bookModel)
                        {
                            bookModel.classList.remove('open');
                        }
                        this.isBookOpen = false;
                        console.log("Book model closed.");
                    }

                    // Clear the note input and display
                    if (this.noteInput) this.noteInput.value = '';
                    if (this.noteDisplay) this.noteDisplay.textContent = '';
                    if (this.noteDisplay) this.noteDisplay.classList.remove('visible');
                    if (this.noteInput) this.noteInput.style.display = 'block'; // Ensure input is visible for new notes
                    console.log("Note and input cleared/reset.");

                    // Clear all stickers from the customization page
                    const currentStickersOnPage = this.bookFirstPage.querySelectorAll('.sticker');
                    currentStickersOnPage.forEach(sticker => sticker.remove());
                    this.stickers = []; // Clear the stickers array
                    console.log("Stickers cleared.");
                }

                // Share functions (dummy implementations for email/social)
                sendEmail () {
                    const subject = encodeURIComponent('Check out this book gift!');
                    const body = encodeURIComponent('I found a great book for you! Here is the link: ' + window.location.href);
                    window.open(`mailto:?subject=${ subject }&body=${ body }`);
                }

                shareSocial () {
                    if (navigator.share)
                    {
                        navigator.share({
                            title: 'Book Gift',
                            text: 'Check out this personalized book gift!',
                            url: window.location.href
                        });
                    } else
                    {
                        console.log('Sharing not supported on this browser');
                    }
                }

                async copyShareableLink () {
                    if (!this.selectedBook)
                    {
                        console.error("No book selected to share.");
                        alert("Please select a book first!");
                        return;
                    }

                    const senderName = this.senderNameInput.value.trim();
                    const noteContent = this.noteInput.value;
                    const noteFont = this.noteInput.style.fontFamily || 'Caveat';

                    // Prepare sticker data for saving (only necessary properties)
                    const stickersToSave = this.stickers.map(s => ({
                        emoji: s.emoji,
                        left: s.left,
                        top: s.top,
                        fontSize: s.fontSize
                    }));

                    const customizationData = {
                        book: this.selectedBook,
                        note: noteContent,
                        font: noteFont,
                        stickers: stickersToSave, // Save simplified sticker data
                        senderName: senderName,
                        timestamp: new Date().toISOString() // Save as ISO string for consistent sorting/parsing
                    };

                    try
                    {
                        // Save to Firestore
                        // Collection path: /artifacts/{appId}/public/data/bookCustomizations
                        const docRef = await addDoc(collection(this.db, `artifacts/${ appId }/public/data/bookCustomizations`), customizationData);
                        const shareableLink = `${ window.location.origin }${ window.location.pathname }?view=${ docRef.id }`;

                        // Copy to clipboard
                        const dummyElement = document.createElement('textarea');
                        dummyElement.value = shareableLink;
                        document.body.appendChild(dummyElement);
                        dummyElement.select();
                        document.execCommand('copy');
                        document.body.removeChild(dummyElement);

                        // Show tooltip
                        if (this.copyTooltip)
                        {
                            this.copyTooltip.classList.add('show');
                            setTimeout(() => {
                                this.copyTooltip.classList.remove('show');
                            }, 2000); // Show for 2 seconds
                        }

                        console.log('Shareable link copied to clipboard:', shareableLink);
                    } catch (error)
                    {
                        console.error("Error saving customization or copying link:", error);
                        alert("Failed to generate shareable link. Please try again.");
                    }
                }

                async loadViewOnlyBook (viewId) {
                    // Hide all other pages
                    this.mainLandingPage.style.display = 'none';
                    this.bookDisplayArea.style.display = 'none';
                    this.sharePage.style.display = 'flex'; // Show the share page for view-only

                    // Hide original share page heading and controls
                    if (this.sharePageOriginalHeading) this.sharePageOriginalHeading.style.display = 'none';
                    if (this.shareDetailsWrapper) this.shareDetailsWrapper.style.display = 'none';
                    // The back to editing link is still useful in view-only mode to go back to customization.
                    // if (this.backToEditingLink) this.backToEditingLink.style.display = 'none'; // Hide back to editing

                    // Show view-only heading
                    if (this.viewOnlyHeading) this.viewOnlyHeading.style.display = 'block';

                    try
                    {
                        const docRef = doc(this.db, `artifacts/${ appId }/public/data/bookCustomizations`, viewId);
                        const docSnap = await getDoc(docRef);

                        if (docSnap.exists())
                        {
                            const data = docSnap.data();
                            this.selectedBook = data.book;
                            const noteContent = data.note;
                            const noteFont = data.font;
                            const stickersData = data.stickers || [];
                            const senderName = data.senderName || 'Someone';

                            // Set the view-only heading
                            if (this.viewOnlyHeading)
                            {
                                this.viewOnlyHeading.innerHTML = `
                                <span style="color: #A0522D;">${ senderName }</span> has sent you a book recommendation, <br>
                                tap to see what's inside!
                            `;
                            }

                            // Display the book cover on the share page preview
                            this.displayBook(this.shareBookCoverFront, this.shareBookCoverInside);

                            // Set note content and font
                            if (this.shareNoteDisplay)
                            {
                                this.shareNoteDisplay.textContent = noteContent;
                                this.shareNoteDisplay.style.fontFamily = noteFont;
                                this.shareNoteDisplay.classList.add('visible');
                            }

                            // Clear any existing stickers from previous views
                            const currentShareStickers = this.shareBookFirstPage.querySelectorAll('.sticker');
                            currentShareStickers.forEach(sticker => sticker.remove());

                            // Recreate stickers for view-only display
                            stickersData.forEach(sData => {
                                const sticker = document.createElement('div');
                                sticker.className = 'sticker';
                                sticker.style.position = 'absolute';
                                sticker.innerHTML = `
                                <span class="sticker-emoji" style="font-size: ${ sData.fontSize }px;">${ sData.emoji }</span>
                            `;
                                sticker.style.left = `${ sData.left }px`;
                                sticker.style.top = `${ sData.top }px`;
                                // No drag/resize for view-only stickers
                                this.shareBookFirstPage.appendChild(sticker);
                            });

                            // Automatically open the book
                            setTimeout(() => {
                                this.toggleShareBook(); // Open the book on the share page
                            }, 500);

                        } else
                        {
                            console.error("No such document for view ID:", viewId);
                            if (this.viewOnlyHeading) this.viewOnlyHeading.textContent = "Oops! This book recommendation could not be found.";
                        }
                    } catch (error)
                    {
                        console.error("Error fetching view-only book:", error);
                        if (this.viewOnlyHeading) this.viewOnlyHeading.textContent = "Error loading book recommendation. Please try again later.";
                    }
                }
            }

            // Initialize the app when the page loads
            document.addEventListener('DOMContentLoaded', () => {
                window.bookApp = new BookApp(); // Assign to window.bookApp
            });
        </script>
</body>

</html>